---
title: "fire-occurrence"
author: "Helen Evangelina"
date: "23/09/2021"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(shiny)
library(dplyr)
library(leaflet)
library(readr)
library(KernSmooth)
library(shinyWidgets)
library(plotly)
library(sp)
library(mapview)
library(leafem)
library(rgdal)
library(maptools)
library(raster)
library(DT)
library(htmlwidgets)
library(lubridate)
library(forcats)
```



```{r}
training <- read.csv("data/training.csv")

predict <- read.csv("data/predict_x.csv")

predict <- select(predict, -FOREST, -FOR_CODE, -FOR_CAT)
  
predict <- mutate(predict,
                     year = factor(year(time)),
                     month = factor(month(time), levels = c(10,11,12,1,2,3,4,5,6,7,8,9)),
                     day = factor(day(time), levels = c(1:31)),
                     wod = factor(wday(time), levels = c(1:7)))

predict <- mutate(predict,
                     log_dist_cfa = log(dist_cfa),
                     log_dist_camp = log(dist_camp),
                     log_dist_road = log(dist_road),
                     COVER = factor(COVER),
                     HEIGHT = factor(HEIGHT))

predict <- predict %>%
  select(-time, -id, -dist_cfa, - dist_camp, -dist_road) 
  
```

```{r}
training <- training %>%
    filter(!CAUSE %in% c("BURNING BUILDING",
                         "WASTE DISPOSAL, INDUSTRIAL, SAWMILL, TIP",
                         "WASTE DISPOSAL, DOMESTIC",
                         "BURNING VEHICLE, MACHINE",
                         "BURNING BUILDING")) %>%
    filter(new_cause != "other") %>%
    filter(new_cause != "relight")
  
  
  training <- select(training, -c(EVENTID:FIRE_NUM), -id, -CAUSE, -FOREST, -FOR_CODE, -FOR_CAT)
  
  training <- mutate(training,
                     year = factor(year(FIRE_START)),
                     month = factor(month(FIRE_START), levels = c(10,11,12,1,2,3)),
                     day = factor(day(FIRE_START), levels = c(1:31)),
                     wod = factor(wday(FIRE_START), levels = c(1:7)))
  
  training <- filter(training, month %in% c(10,11,12,1,2,3))
  
  training <- na.omit(training)
  
  training <- mutate(training, new_cause = ifelse(new_cause == "accidental_human", "accident", new_cause)) %>%
    mutate(new_cause = ifelse(new_cause == "burning_off_human", "burning_off", new_cause)) %>%
    mutate(new_cause = factor(new_cause)) %>%
    mutate(FOR_TYPE = factor(FOR_TYPE))
  
#  training <- na.omit(training)
  
  training <- mutate(training,
                     log_dist_cfa = log(dist_cfa),
                     log_dist_camp = log(dist_camp),
                     log_dist_road = log(dist_road),
                     COVER = factor(COVER),
                     HEIGHT = factor(HEIGHT))
  
  training <- rename(training, cause = new_cause)
  training <- mutate(training,
                     cause = fct_relevel(cause,
                                         "lightning",
                                         "accident",
                                         "arson",
                                         "burning_off"))
  
  training <- na.omit(training)
  
  training <- select(training, -dist_road, -dist_cfa, -dist_camp, -FIRE_START, -cause)
```

```{r}
joined_data <- rbind(training, predict)
```

```{r}
lat_lon <- joined_data %>%
  select(lat, lon, year)
```


```{r}
yearly_data <- joined_data %>% 
  group_by(year) %>%
  summarise(count = n())
```

```{r}
coordinates(lat_lon) = c("lon", "lat")

```


```{r}
library(sf)
library(sp)
library(rnaturalearth)
au_map <- ne_states(country = 'Australia', returnclass = 'sf')
vic_map <- au_map[7,]
```

```{r}
vic_map %>%
  ggplot() +
  geom_sf()
```

```{r}
vic_raster <- raster(
  nrows = 50,
  ncols = 50,
  
  xmn = 140.9617,
  xmx = 149.9763,
  ymn = -39.13396,
  ymx = -33.99605,
  
  crs = "+proj=longlat +datum=WGS84",
  
  vals = seq(from = 1, to = 2500000, by = 1000)
  
)
```

```{r}
raster::values(vic_raster) <- stats::runif(raster::ncell(vic_raster))

vic_map_sp <- as(vic_map, Class = "Spatial")
```

```{r}
vic_raster_crop <- vic_raster %>% 
  raster::mask(mask = vic_map_sp)

vic_raster_crop
```

```{r}
plot(vic_raster_crop)
```

# with the data
```{r}
training_jan_count <- training_jan %>%
  group_by(lat, lon) %>%
  summarise(n = n())
```

```{r}
# set up projection parameter for use throughout script
projection <- "+proj=longlat +datum=WGS84"

# set up extent parameter 
ext <- extent(141, 150, -39, -34)

x <- raster(xmn = 141,
            xmx = 150, 
            ymn = -39,
            ymx = -34,
            res = 0.2, 
            crs = "+proj=longlat +datum=WGS84")

fire_data <- rasterize(joined_data[, c('lon', 'lat')], x, joined_data[, c('arf360')])

fire_projected <- projectRaster(fire_data, crs = projection)

fire_extended <- extend(fire_projected_jan, ext, value = NA)

plot(fire_extended)
```

```{r}

```








# using the gridRecords function
```{r}
gridRecords <- function(rst,
                        pres.coords,
                        abs.coords = NULL,
                        na.rm = TRUE) {
  
  # version 2.0 (3 Feb 2020)
  
  if (!requireNamespace("raster")) stop("This function requires installing the 'raster' package first.")
  
  if (is.null(abs.coords)) {
    abs.coords <- raster::coordinates(rst)
  }

  p_extract <- raster::extract(rst, pres.coords, cellnumbers = TRUE, df = TRUE)[ , -1]
  a_extract <- raster::extract(rst, abs.coords, cellnumbers = TRUE, df = TRUE)[ , -1]
  
  p_extract <- unique(p_extract)
  a_extract <- unique(a_extract)
  
  a_extract <- a_extract[!(a_extract$cells %in% p_extract$cells), ]
  
  p_centroids <- raster::xyFromCell(rst, p_extract$cells)
  a_centroids <- raster::xyFromCell(rst, a_extract$cells)
  
  p_extract <- data.frame(presence = 1, p_centroids, p_extract)
  if (nrow(a_extract) > 0) {
    a_extract <- data.frame(presence = 0, a_centroids, a_extract)
  }
  
  result <- rbind(p_extract, a_extract)
  
  if (na.rm) {
    result_NA <- which(apply(result[ , 5:ncol(result)], MARGIN = 1, FUN = function(x) all(is.na(x))))
    if (length(result_NA) > 0) {
      result <- result[-result_NA, ]
    }
  }
  
  return(result)
}
```

```{r}
# set up projection parameter for use throughout script
projection <- "+proj=longlat +datum=WGS84"

# set up extent parameter 
ext <- extent(141, 150, -39, -34)

x <- raster(xmn = 141,
            xmx = 150, 
            ymn = -39,
            ymx = -34,
            res = 0.2, 
            crs = "+proj=longlat +datum=WGS84")

fire_data <- rasterize(joined_data[, c('lon', 'lat')], x, joined_data[, c('arf360')])

fire_projected <- projectRaster(fire_data, crs = projection)

fire_extended <- extend(fire_projected_jan, ext, value = NA)

plot(fire_extended)

set.seed(2021)
presences <- sp::spsample(as(ext, "SpatialPolygons"), 50, type = "random")
absences <- sp::spsample(as(ext, "SpatialPolygons"), 50, type = "random")
points(presences, pch = 20, cex = 0.2, col = "black")
points(absences, pch = 20, cex = 0.2, col = "white")

# you can also do it with only presence (no absence) records:
gridded_pres <- gridRecords(fire_extended, coordinates(presences))
head(gridded_pres)
plot(rst[[1]])
points(presences, pch = 20, cex = 0.2, col = "black")
pres_coords <- gridded_pres[gridded_pres$presence == 1, c("x", "y")]
abs_coords <- gridded_pres[gridded_pres$presence == 0, c("x", "y")]
points(gridded_pres[ , c("x", "y")], pch = 4, cex = 0.6, col = gridded_pres$presence)
```





```{r}
r <- setValues(vic_raster, sample(x = 0:1, size = ncell(vic_raster), replace = T))

plot(r)
```

```{r}
joined_data_raster <- joined_data %>%
  
```

```{r}

```




```{r}
# aggregate raster object to create a new RasterLayer with a lower resolution (larger cells)
r_agg <- aggregate(x = r, fact = 50, fun = sum)
```











```{r}
values(vic_raster_crop)
```


```{r}
name <- levels(vic_raster_crop)
head(name[[1]])
colnames(
